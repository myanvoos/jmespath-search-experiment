const jsonData = {
    "cmake": {
      "project": "cmake",
      "benchmarks": {
        "output-cmake-xml_externalentityparsercreate": {
          "samples": [
            {
              "sample": "01",
              "status": true,
              "compiles": true,
              "crashes": false,
              "total_coverage": 0.07595118449389807,
              "total_line_coverage_diff": 0.0
            },
            {
              "sample": "02",
              "status": true,
              "compiles": true,
              "crashes": false,
              "total_coverage": 0.07207465900933238,
              "total_line_coverage_diff": 0.0
            }
          ],
          "status": "Done",
          "build_success_rate": 1.0,
          "crash_rate": 0.0,
          "total_coverage": 0.14802584350323045,
          "average_coverage": 0.07401292175161522,
          "total_line_coverage_diff": 0.0,
          "average_line_coverage_diff": 0.0
        },
        "output-cmake-xml_externalentityparsercreate copy": {
          "samples": [
            {
              "sample": "01",
              "status": true,
              "compiles": true,
              "crashes": false,
              "total_coverage": 0.07595118449389807,
              "total_line_coverage_diff": 0.0
            },
            {
              "sample": "02",
              "status": true,
              "compiles": true,
              "crashes": false,
              "total_coverage": 0.07207465900933238,
              "total_line_coverage_diff": 0.0
            }
          ],
          "status": "Done",
          "build_success_rate": 1.0,
          "crash_rate": 0.0,
          "total_coverage": 0.14802584350323045,
          "average_coverage": 0.07401292175161522,
          "total_line_coverage_diff": 0.0,
          "average_line_coverage_diff": 0.0
        },
        "output-cmake-xml_parsercreatens": {
          "samples": [
            {
              "sample": "01",
              "status": true,
              "compiles": true,
              "crashes": false,
              "total_coverage": 0.0743718592964824,
              "total_line_coverage_diff": 0.0
            },
            {
              "sample": "02",
              "status": true,
              "compiles": true,
              "crashes": false,
              "total_coverage": 0.07465900933237617,
              "total_line_coverage_diff": 0.0
            }
          ],
          "status": "Done",
          "build_success_rate": 1.0,
          "crash_rate": 0.0,
          "total_coverage": 0.14903086862885856,
          "average_coverage": 0.07451543431442928,
          "total_line_coverage_diff": 0.0,
          "average_line_coverage_diff": 0.0
        },
        "output-cmake-xml_parserreset": {
          "samples": [
            {
              "sample": "01",
              "status": true,
              "compiles": true,
              "crashes": false,
              "total_coverage": 0.06949030868628858,
              "total_line_coverage_diff": 0.0
            },
            {
              "sample": "02",
              "status": true,
              "compiles": true,
              "crashes": false,
              "total_coverage": 0.06417803302225412,
              "total_line_coverage_diff": 0.0
            }
          ],
          "status": "Done",
          "build_success_rate": 1.0,
          "crash_rate": 0.0,
          "total_coverage": 0.1336683417085427,
          "average_coverage": 0.06683417085427135,
          "total_line_coverage_diff": 0.0,
          "average_line_coverage_diff": 0.0
        },
        "output-cmake-xml_setbase": {
          "samples": [
            {
              "sample": "01",
              "status": true,
              "compiles": true,
              "crashes": false,
              "total_coverage": 0.07078248384781048,
              "total_line_coverage_diff": 0.0
            },
            {
              "sample": "02",
              "status": true,
              "compiles": true,
              "crashes": false,
              "total_coverage": 0.07351040918880115,
              "total_line_coverage_diff": 0.0
            }
          ],
          "status": "Done",
          "build_success_rate": 1.0,
          "crash_rate": 0.0,
          "total_coverage": 0.14429289303661164,
          "average_coverage": 0.07214644651830582,
          "total_line_coverage_diff": 0.0,
          "average_line_coverage_diff": 0.0
        },
        "output-cmake-xmlinitunknownencoding": {
          "samples": [
            {
              "sample": "01",
              "status": true,
              "compiles": true,
              "crashes": false,
              "total_coverage": 0.07351040918880115,
              "total_line_coverage_diff": 0.0
            },
            {
              "sample": "02",
              "status": true,
              "compiles": true,
              "crashes": false,
              "total_coverage": 0.06776740847092606,
              "total_line_coverage_diff": 0.0
            }
          ],
          "status": "Done",
          "build_success_rate": 1.0,
          "crash_rate": 0.0,
          "total_coverage": 0.14127781765972722,
          "average_coverage": 0.07063890882986361,
          "total_line_coverage_diff": 0.0,
          "average_line_coverage_diff": 0.0
        }
      },
      "average_max_coverage": 0.0,
      "average_max_line_coverage_diff": 0.0,
      "ofg_total_new_covered_lines": 0,
      "ofg_total_covered_lines": 1744,
      "existing_total_covered_lines": 3701,
      "existing_total_lines": 7840,
      "average_build_success_rate": 1.0,
      "average_crash_rate": 0.0
    },
    "hiredis": {
      "project": "hiredis",
      "benchmarks": {
        "output-hiredis-redisasyncread": {
          "samples": [
            {
              "sample": "01",
              "status": true,
              "compiles": true,
              "crashes": true,
              "total_coverage": 0.051860649247822646,
              "total_line_coverage_diff": 0.037486218302094816
            },
            {
              "sample": "02",
              "status": true,
              "compiles": false,
              "crashes": false,
              "total_coverage": 0,
              "total_line_coverage_diff": 0
            }
          ],
          "status": "Done",
          "build_success_rate": 0.5,
          "crash_rate": 0.5,
          "total_coverage": 0.051860649247822646,
          "average_coverage": 0.025930324623911323,
          "total_line_coverage_diff": 0.037486218302094816,
          "average_line_coverage_diff": 0.018743109151047408
        },
        "output-hiredis-rediscommand": {
          "samples": [
            {
              "sample": "01",
              "status": true,
              "compiles": true,
              "crashes": true,
              "total_coverage": 0.043547110055423596,
              "total_line_coverage_diff": 0.028941565600882027
            },
            {
              "sample": "02",
              "status": true,
              "compiles": true,
              "crashes": true,
              "total_coverage": 0.05027711797307997,
              "total_line_coverage_diff": 0.027287761852260197
            }
          ],
          "status": "Done",
          "build_success_rate": 1.0,
          "crash_rate": 1.0,
          "total_coverage": 0.09382422802850357,
          "average_coverage": 0.046912114014251785,
          "total_line_coverage_diff": 0.05622932745314223,
          "average_line_coverage_diff": 0.028114663726571114
        },
        "output-hiredis-rediscommandargv": {
          "samples": [
            {
              "sample": "01",
              "status": true,
              "compiles": true,
              "crashes": true,
              "total_coverage": 0.034045922406967535,
              "total_line_coverage_diff": 0.025082690187431093
            },
            {
              "sample": "02",
              "status": true,
              "compiles": true,
              "crashes": false,
              "total_coverage": 0.052256532066508314,
              "total_line_coverage_diff": 0.03500551267916207
            }
          ],
          "status": "Done",
          "build_success_rate": 1.0,
          "crash_rate": 0.5,
          "total_coverage": 0.08630245447347584,
          "average_coverage": 0.04315122723673792,
          "total_line_coverage_diff": 0.060088202866593166,
          "average_line_coverage_diff": 0.030044101433296583
        },
        "output-hiredis-redisprocesscallbacks": {
          "samples": [
            {
              "sample": "01",
              "status": true,
              "compiles": true,
              "crashes": false,
              "total_coverage": 0.04671417260490895,
              "total_line_coverage_diff": 0.03307607497243661
            },
            {
              "sample": "02",
              "status": true,
              "compiles": true,
              "crashes": true,
              "total_coverage": 0.04117181314330958,
              "total_line_coverage_diff": 0.02701212789415656
            }
          ],
          "status": "Done",
          "build_success_rate": 1.0,
          "crash_rate": 0.5,
          "total_coverage": 0.08788598574821853,
          "average_coverage": 0.043942992874109264,
          "total_line_coverage_diff": 0.060088202866593166,
          "average_line_coverage_diff": 0.030044101433296583
        },
        "output-hiredis-redisvcommand": {
          "samples": [
            {
              "sample": "01",
              "status": true,
              "compiles": true,
              "crashes": true,
              "total_coverage": 0.047110055423594616,
              "total_line_coverage_diff": 0.029492833517089305
            },
            {
              "sample": "02",
              "status": true,
              "compiles": true,
              "crashes": true,
              "total_coverage": 0.050673000791765635,
              "total_line_coverage_diff": 0.03362734288864388
            }
          ],
          "status": "Done",
          "build_success_rate": 1.0,
          "crash_rate": 1.0,
          "total_coverage": 0.09778305621536025,
          "average_coverage": 0.048891528107680125,
          "total_line_coverage_diff": 0.06312017640573318,
          "average_line_coverage_diff": 0.03156008820286659
        }
      },
      "average_max_coverage": 0.03761669412410763,
      "average_max_line_coverage_diff": 0.6715686274509803,
      "ofg_total_new_covered_lines": 137,
      "ofg_total_covered_lines": 341,
      "existing_total_covered_lines": 204,
      "existing_total_lines": 3642,
      "average_build_success_rate": 0.9,
      "average_crash_rate": 0.7
    },
    "janet": {
      "project": "janet",
      "benchmarks": {
        "output-janet-janet_loop_fiber": {
          "samples": [
            {
              "sample": "01",
              "status": true,
              "compiles": true,
              "crashes": true,
              "total_coverage": 0.0,
              "total_line_coverage_diff": 0.0
            },
            {
              "sample": "02",
              "status": true,
              "compiles": true,
              "crashes": true,
              "total_coverage": 0.0,
              "total_line_coverage_diff": 0.0
            }
          ],
          "status": "Done",
          "build_success_rate": 1.0,
          "crash_rate": 1.0,
          "total_coverage": 0.0,
          "average_coverage": 0.0,
          "total_line_coverage_diff": 0.0,
          "average_line_coverage_diff": 0.0
        }
      },
      "average_max_coverage": 0.05053285968028419,
      "average_max_line_coverage_diff": 0.6551525618883132,
      "ofg_total_new_covered_lines": 1138,
      "ofg_total_covered_lines": 1828,
      "existing_total_covered_lines": 1737,
      "existing_total_lines": 22520,
      "average_build_success_rate": 1.0,
      "average_crash_rate": 1.0
    },
    "sqlite3": {
      "project": "sqlite3",
      "benchmarks": {
        "output-sqlite3-sqlite3_blob_open": {
          "samples": [
            {
              "sample": "01",
              "status": true,
              "compiles": true,
              "crashes": false,
              "total_coverage": 0.1583782843222551,
              "total_line_coverage_diff": 0.031477413575171496
            },
            {
              "sample": "02",
              "status": true,
              "compiles": true,
              "crashes": false,
              "total_coverage": 0.1648686271097964,
              "total_line_coverage_diff": 0.0325818842269319
            }
          ],
          "status": "Done",
          "build_success_rate": 1.0,
          "crash_rate": 0.0,
          "total_coverage": 0.32324691143205153,
          "average_coverage": 0.16162345571602577,
          "total_line_coverage_diff": 0.0640592978021034,
          "average_line_coverage_diff": 0.0320296489010517
        },
        "output-sqlite3-sqlite3_get_table": {
          "samples": [
            {
              "sample": "01",
              "status": true,
              "compiles": true,
              "crashes": false,
              "total_coverage": 0.16065773447015835,
              "total_line_coverage_diff": 0.0326677874998466
            },
            {
              "sample": "02",
              "status": true,
              "compiles": true,
              "crashes": false,
              "total_coverage": 0.16354619801635636,
              "total_line_coverage_diff": 0.03233644630431848
            }
          ],
          "status": "Done",
          "build_success_rate": 1.0,
          "crash_rate": 0.0,
          "total_coverage": 0.3242039324865147,
          "average_coverage": 0.16210196624325734,
          "total_line_coverage_diff": 0.06500423380416508,
          "average_line_coverage_diff": 0.03250211690208254
        },
        "output-sqlite3-sqlite3_open": {
          "samples": [
            {
              "sample": "01",
              "status": true,
              "compiles": true,
              "crashes": false,
              "total_coverage": 0.16927092396032714,
              "total_line_coverage_diff": 0.03315866334507345
            },
            {
              "sample": "02",
              "status": true,
              "compiles": true,
              "crashes": false,
              "total_coverage": 0.16199756394640683,
              "total_line_coverage_diff": 0.03276596266889197
            }
          ],
          "status": "Done",
          "build_success_rate": 1.0,
          "crash_rate": 0.0,
          "total_coverage": 0.33126848790673397,
          "average_coverage": 0.16563424395336698,
          "total_line_coverage_diff": 0.06592462601396543,
          "average_line_coverage_diff": 0.03296231300698271
        },
        "output-sqlite3-sqlite3_open16": {
          "samples": [
            {
              "sample": "01",
              "status": true,
              "compiles": true,
              "crashes": false,
              "total_coverage": 0.16088393944666782,
              "total_line_coverage_diff": 0.03242234957723318
            },
            {
              "sample": "02",
              "status": true,
              "compiles": true,
              "crashes": false,
              "total_coverage": 0.16004872107186358,
              "total_line_coverage_diff": 0.032937769214721364
            }
          ],
          "status": "Done",
          "build_success_rate": 1.0,
          "crash_rate": 0.0,
          "total_coverage": 0.3209326605185314,
          "average_coverage": 0.1604663302592657,
          "total_line_coverage_diff": 0.06536011879195455,
          "average_line_coverage_diff": 0.032680059395977276
        },
        "output-sqlite3-sqlite3_test_control": {
          "samples": [
            {
              "sample": "01",
              "status": true,
              "compiles": true,
              "crashes": false,
              "total_coverage": 0.16636506003132068,
              "total_line_coverage_diff": 0.03337955747542553
            },
            {
              "sample": "02",
              "status": true,
              "compiles": true,
              "crashes": false,
              "total_coverage": 0.1616669566730468,
              "total_line_coverage_diff": 0.0322014554468811
            }
          ],
          "status": "Done",
          "build_success_rate": 1.0,
          "crash_rate": 0.0,
          "total_coverage": 0.3280320167043675,
          "average_coverage": 0.16401600835218375,
          "total_line_coverage_diff": 0.06558101292230663,
          "average_line_coverage_diff": 0.032790506461153314
        }
      },
      "average_max_coverage": 0.27413917797472387,
      "average_max_line_coverage_diff": 0.43446333171442447,
      "ofg_total_new_covered_lines": 22364,
      "ofg_total_covered_lines": 46877,
      "existing_total_covered_lines": 51475,
      "existing_total_lines": 81579,
      "average_build_success_rate": 1.0,
      "average_crash_rate": 0.0
    }
  }

function benchmarkStringSearchJS(data, searchTerm) {
    const results = [];
    const lowerSearchTerm = searchTerm.toLowerCase();
    Object.entries(data).forEach(([projectKey, projectValue]) => {
        let matchFoundInProject = false;
        if (projectKey.toLowerCase().includes(lowerSearchTerm)) {
            matchFoundInProject = true;
        }
        if (!matchFoundInProject && projectValue && typeof projectValue === 'object') {
            if (typeof projectValue.project === 'string' && projectValue.project.toLowerCase().includes(lowerSearchTerm)) {
                matchFoundInProject = true;
            }
            if (!matchFoundInProject && projectValue.benchmarks && typeof projectValue.benchmarks === 'object') {
                for (const [benchmarkKey, benchmarkValue] of Object.entries(projectValue.benchmarks)) {
                    if (benchmarkKey.toLowerCase().includes(lowerSearchTerm)) {
                        matchFoundInProject = true; break;
                    }
                    if (!matchFoundInProject && benchmarkValue && typeof benchmarkValue === 'object') {
                        if (typeof benchmarkValue.status === 'string' && benchmarkValue.status.toLowerCase().includes(lowerSearchTerm)) {
                            matchFoundInProject = true; break;
                        }
                        if (!matchFoundInProject && Array.isArray(benchmarkValue.samples)) {
                            for (const sampleObj of benchmarkValue.samples) {
                                if (sampleObj && typeof sampleObj.sample === 'string' && sampleObj.sample.toLowerCase().includes(lowerSearchTerm)) {
                                    matchFoundInProject = true; break;
                                }
                            }
                            if (matchFoundInProject) break;
                        }
                    }
                    if (matchFoundInProject) break;
                }
            }
        }
        if (matchFoundInProject) {
            if (!results.some(existing => existing === projectValue)) {
                 results.push(projectValue);
            }
        }
    });
    return results;
}

function filterCrashedBenchmarks(data, shouldCrash) {
    if (!data) return [];
    const crashValue = String(shouldCrash).toLowerCase() === 'true';

    const query = `values(@)[?length(benchmarks.*.samples[] | [?crashes == \`${crashValue}\`]) > \`0\`].benchmarks`;

    console.log(`Executing crash filter query: ${query}`);
    try {
        const results = jmespath.search(data, query);
        return Array.isArray(results) ? results : [];
    } catch (e) {
        console.error(`Error during JMESPath crash filter (value: ${crashValue}):`, e);
        return [];
    }
}

function filterBenchmarksByCoverage(data, threshold, operator = '>') {
    if (!data) return [];
    const numericThreshold = parseFloat(threshold);

    const validOperators = ['>', '<', '==', '>=', '<='];
    if (!validOperators.includes(operator)) {
        console.warn(`Invalid coverage operator: "${operator}". Using '>'.`);
        operator = '>';
    }

    const query = `values(@)[?length(benchmarks.*.samples[] | [?total_coverage ${operator} \`${numericThreshold}\`]) > \`0\`].benchmarks`;

    console.log(`Executing coverage filter query: ${query}`);
    try {
        const results = jmespath.search(data, query);
        return Array.isArray(results) ? results : [];
    } catch (e) {
        console.error(`Error during JMESPath coverage filter (threshold: ${numericThreshold}, operator: ${operator}):`, e);
        return [];
    }
}


function setupEventListeners() {
    const searchInput = document.getElementById('search');
    const crashFilterInput = document.getElementById('crashFilter');
    const covFilterInput = document.getElementById('covFilter');
    const searchButton = document.querySelector('button');

    if (!searchInput || !crashFilterInput || !covFilterInput || !searchButton) {
        console.error("One or more input elements or the button were not found!"); return;
    }

    searchButton.addEventListener('click', () => {
        if (!jsonData) {
            alert("Data is still loading or failed to load. Please try again."); return;
        }

        const searchTerm = searchInput.value.trim();
        const crashCriteria = crashFilterInput.value.trim();
        const covCriteria = covFilterInput.value.trim();

        let resultsToDisplay = [];
        let displayType = 'none'; // 'projects', 'benchmarks_list', 'none'

        const isCrashFilterActive = crashCriteria !== "";
        const isCovFilterActive = covCriteria !== "";

        if (isCrashFilterActive || isCovFilterActive) {
            displayType = 'benchmarks_list'; 
            let filteredBenchmarkObjects = [];

            if (isCrashFilterActive) {
                console.log(`Filtering by crash: "${crashCriteria}" (using JMESPath)`);
                filteredBenchmarkObjects = filterCrashedBenchmarks(jsonData, crashCriteria);

                if(isCovFilterActive) {
                   console.log(`Applying coverage filter > "${covCriteria}" to crash results (using JS)`);
                   const numericThreshold = parseFloat(covCriteria);
                   const operator = '>'; 
                   if (!isNaN(numericThreshold)){
                       const doublyFiltered = [];
                       filteredBenchmarkObjects.forEach(benchObj => {
                           const matchingEntries = Object.entries(benchObj).filter(([key, benchVal]) =>
                               benchVal.samples && benchVal.samples.some(sample => {
                                   switch(operator) {
                                       case '>': return sample.total_coverage > numericThreshold;
                                       case '<': return sample.total_coverage < numericThreshold;
                                       case '==': return sample.total_coverage == numericThreshold; 
                                       case '>=': return sample.total_coverage >= numericThreshold;
                                       case '<=': return sample.total_coverage <= numericThreshold;
                                       default: return false;
                                   }
                               })
                           );

                           if (matchingEntries.length > 0) {
                               doublyFiltered.push(Object.fromEntries(matchingEntries));
                           }
                       });
                       filteredBenchmarkObjects = doublyFiltered;
                   }
                }

            } else if (isCovFilterActive) {
                console.log(`Filtering by coverage > "${covCriteria}" (using JMESPath)`);
                filteredBenchmarkObjects = filterBenchmarksByCoverage(jsonData, covCriteria, '>');
            }

             console.log("Filtered results:", filteredBenchmarkObjects);
             resultsToDisplay = filteredBenchmarkObjects;

        } else if (searchTerm !== "") {
            // Only general search is active
             displayType = 'projects';
            console.log(`Searching for: "${searchTerm}"`);
            resultsToDisplay = benchmarkStringSearchJS(jsonData, searchTerm);
            console.log("General Search Results (Projects):", resultsToDisplay);

        } else {
            displayType = 'none';
            resultsToDisplay = [];
            console.log("No search terms or filters active.");
        }

        displayResults(resultsToDisplay, displayType);
    });
}


function displayResults(results, type = 'none') {
    const resultsContainer = document.getElementById('resultsDisplay');

    resultsContainer.innerHTML = '';

    if (type === 'none' || !results || !Array.isArray(results) || results.length === 0) {
        resultsContainer.textContent = 'No matching results found.';
        return;
    }
    const ul = document.createElement('ul');
    let itemsAdded = 0; 

    try {
        if (type === 'projects') {
            resultsContainer.innerHTML = '<h2>Matching Projects:</h2>'; 
            results.forEach((project, index) => {
                if (project && typeof project === 'object' && project.project) {
                    const li = document.createElement('li');
                    const pre = document.createElement('pre');
                    pre.textContent = JSON.stringify(project, null, 2);
                    li.textContent = `Project: ${project.project}`;
                    li.appendChild(pre);
                    ul.appendChild(li);
                    itemsAdded++;
                } 
            });

        } else if (type === 'benchmarks_list') {
            resultsContainer.innerHTML = '<h2>Matching Benchmarks:</h2>'; 
            results.forEach((projectBenchmarksObject, index) => {
                if (projectBenchmarksObject && typeof projectBenchmarksObject === 'object') {
                    Object.entries(projectBenchmarksObject).forEach(([benchmarkKey, benchmarkValue]) => {
                        const li = document.createElement('li');
                        const pre = document.createElement('pre');
                        pre.textContent = JSON.stringify(benchmarkValue, null, 2);
                        li.textContent = `Benchmark: ${benchmarkKey}`;
                        li.appendChild(pre);
                        ul.appendChild(li);
                        itemsAdded++;
                    });
                }
            });

        } else {
             resultsContainer.textContent = 'Invalid display type specified.';
             return;
        }

        if (itemsAdded > 0) {
            resultsContainer.appendChild(ul);
        } else {
            resultsContainer.textContent = 'No matching results found for the selected filters.';
        }

    } catch (error) {
        console.error("Error during displayResults:", error);
        resultsContainer.textContent = 'An error occurred while displaying results.';
    }
}

document.addEventListener('DOMContentLoaded', async () => {
    console.log("DOM fully loaded and parsed");
    if (jsonData) {
        setupEventListeners();

        const originalJSONDisplay = document.getElementById('jsonData');
        originalJSONDisplay.innerHTML = JSON.stringify(jsonData, null, 3);

        if (!document.getElementById('resultsDisplay')) {
            const resultsDiv = document.createElement('div');
            resultsDiv.id = 'resultsDisplay';
            resultsDiv.style.marginTop = '20px';
            document.body.appendChild(resultsDiv);
        }
    } 
});